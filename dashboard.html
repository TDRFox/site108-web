<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SCP Fondation - Tableau de bord</title>
<style>
  body { font-family: Arial, sans-serif; background:#121212; color:#eee; padding:20px; }
  nav a {
    color:#5c6bc0; text-decoration:none; margin-right: 15px;
  }
  nav a.disabled {
    color: #666; pointer-events:none; cursor: default;
  }
  button {
    padding: 8px 12px;
    background:#5c6bc0;
    color:#fff;
    border:none;
    border-radius: 4px;
    cursor:pointer;
  }
  button:hover { background:#3949ab; }
  h1 { margin-bottom: 10px; }
</style>
</head>
<body>

<h1>Tableau de bord SCP Fondation</h1>
<p>Bienvenue, <span id="userEmail"></span></p>
<p>Votre accréditation : <span id="userAccreditation"></span></p>

<nav>
  <a href="#" data-level="1" class="nav-link">Justice Interne</a>
  <a href="#" data-level="2" class="nav-link">Comité d'éthique</a>
  <a href="#" data-level="3" class="nav-link">Personnel Fondationnaire</a>
  <a href="#" data-level="4" class="nav-link">Administration</a>
  <a href="#" data-level="5" class="nav-link">Conseil O5</a>
  <a href="admin.html" id="adminPanelLink" class="nav-link">Panel Admin</a>
</nav>

<button id="logoutBtn">Se déconnecter</button>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBFDgtfyPyNPkM2H8WklNfLqlj-bemVY1E",
  authDomain: "sitedusite108.firebaseapp.com",
  databaseURL: "https://sitedusite108-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "sitedusite108",
  storageBucket: "sitedusite108.firebasestorage.app",
  messagingSenderId: "927427226941",
  appId: "1:927427226941:web:63a9a600bd1c3bfc85a954"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();

auth.onAuthStateChanged(user => {
  if(!user){
    window.location.href = 'index.html';
    return;
  }

  let userDataStr = sessionStorage.getItem('user');

  if(!userDataStr){
    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const data = snapshot.val();
      if(!data){
        alert("Utilisateur non trouvé.");
        auth.signOut();
        window.location.href = 'index.html';
        return;
      }
      if(data.banned){
        alert("Compte banni.");
        auth.signOut();
        window.location.href = 'index.html';
        return;
      }
      const userData = {
        uid: user.uid,
        email: user.email,
        accreditation: data.accreditation,
        banned: data.banned || false,
        staff: data.staff || false
      };
      sessionStorage.setItem('user', JSON.stringify(userData));
      afficherDashboard(userData);
    });
  } else {
    const userData = JSON.parse(userDataStr);
    if(userData.banned){
      alert("Compte banni.");
      auth.signOut();
      window.location.href = 'index.html';
      return;
    }
    afficherDashboard(userData);
  }
});

function afficherDashboard(userData){
  document.getElementById('userEmail').textContent = userData.email;
  document.getElementById('userAccreditation').textContent = userData.accreditation;

  document.querySelectorAll('.nav-link').forEach(a => {
    const lvl = parseInt(a.dataset.level);
    if(isNaN(lvl)){
      if(userData.staff){
        a.style.display = 'inline';
      } else {
        a.style.display = 'none';
      }
      return;
    }
    if(userData.accreditation < lvl){
      a.classList.add('disabled');
      a.href = '#';
    } else {
      a.href = a.textContent.toLowerCase().replace(/\s/g, '') + '.html';
    }
  });
}

document.getElementById('logoutBtn').addEventListener('click', () => {
  sessionStorage.clear();
  auth.signOut();
  window.location.href = 'index.html';
});
</script>

</body>
</html>
